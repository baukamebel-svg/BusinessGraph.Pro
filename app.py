import streamlit as st
import pandas as pd
import plotly.graph_objects as go

# -------------------------------------------------------
# üîµ –ú–ò–ù–ò–ú–ê–õ–ò–°–¢ –î–ò–ó–ê–ô–ù + –ë–ï–¢ –ü–ê–†–ê–ú–ï–¢–†–õ–ï–†–Ü
# -------------------------------------------------------
st.set_page_config(
    page_title="BusinessGraph Pro",
    page_icon="üìà",
    layout="wide"
)

# –§–æ–Ω–¥—ã –∞“õ, –±–ª–æ–∫—Ç–∞—Ä–¥—ã —Å“±—Ä –µ—Ç—ñ–ø –∂–∞—Å–∞—É
minimal_css = """
<style>
    body {
        background-color: #fafafa;
    }
    .block {
        background-color: #f2f2f2;
        padding: 18px;
        border-radius: 10px;
        margin-bottom: 15px;
    }
</style>
"""
st.markdown(minimal_css, unsafe_allow_html=True)

# -------------------------------------------------------
# üîµ –¢–Ü–õ –¢–ê“¢–î–ê–£ (“ö–∞–∑–∞“õ—à–∞ / –†—É—Å—Å–∫–∏–π)
# -------------------------------------------------------
LANG = st.sidebar.selectbox("–¢—ñ–ª / –Ø–∑—ã–∫", ["“ö–∞–∑–∞“õ—à–∞", "–†—É—Å—Å–∫–∏–π"])

TEXT = {
    "“ö–∞–∑–∞“õ—à–∞": {
        "title": "BusinessGraph Pro ‚Äî –∫”ô—Å—ñ–ø–∫–µ—Ä–ª–µ—Ä–≥–µ –∞—Ä–Ω–∞–ª“ì–∞–Ω –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—Ç—ñ –µ—Å–µ–ø “õ“±—Ä–∞–ª—ã",
        "author": "–ê–≤—Ç–æ—Ä–ª–∞—Ä: –ê–±–∏–ª—å–¥–∞–µ–≤–∞ –ê–π–∞—Ä—É, –ï—Ä–∞–ª–∏–µ–≤–∞ –ê–π–±–∏–±—ñ (–ê—Ä–∞–ª –∞—É–¥–∞–Ω—ã ‚Ññ71 –º–µ–∫—Ç–µ–ø)",
        "desc": "–ë“±–ª “õ–æ—Å—ã–º—à–∞ ”©–Ω—ñ–º–¥–µ—Ä–¥—ñ“£ –Ω–∞“õ—Ç—ã ”©–∑—ñ–Ω–¥—ñ–∫ “õ“±–Ω—ã–Ω, –±–∞“ì–∞ “õ–æ—é–¥—ã, —Å–∞—Ç—ã–ª—ã–º –∫”©–ª–µ–º—ñ–Ω –∂”ô–Ω–µ –∂–∏—ã–Ω—Ç—ã“õ –∑–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ –Ω“Ø–∫—Ç–µ—Å—ñ–Ω –µ—Å–µ–ø—Ç–µ—É–≥–µ –∞—Ä–Ω–∞–ª“ì–∞–Ω.",
        "product_create": "1-“õ–∞–¥–∞–º: ”®–Ω—ñ–º–Ω—ñ“£ ”©–∑—ñ–Ω–¥—ñ–∫ “õ“±–Ω—ã–Ω –µ—Å–µ–ø—Ç–µ—É",
        "product_name": "”®–Ω—ñ–º –∞—Ç–∞—É—ã",
        "ingredient_title": "“ö–∞–∂–µ—Ç—Ç—ñ –∑–∞—Ç—Ç–∞—Ä–¥—ã –µ–Ω–≥—ñ–∑—É",
        "ingredient_help": "–ú—ã—Å–∞–ª: “∞–Ω, “õ–∞–Ω—Ç, –∂“±–º—ã—Ä—Ç“õ–∞, –º–∞–π, –∫—Ä–µ–º. –ë–∞“ì–¥–∞—Ä–ª–∞–º–∞ 1 ”©–Ω—ñ–º–≥–µ –∫–µ—Ç–µ—Ç—ñ–Ω –Ω–∞“õ—Ç—ã —à—ã“ì—ã–Ω–¥—ã –∞–≤—Ç–æ–º–∞—Ç—Ç—ã –µ—Å–µ–ø—Ç–µ–π–¥—ñ.",
        "ing_name": "–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –∞—Ç–∞—É—ã",
        "unit_buy": "–°–∞—Ç—ã–ø –∞–ª—ã–Ω“ì–∞–Ω ”©–ª—à–µ–º –±—ñ—Ä–ª—ñ–≥—ñ",
        "unit_need": "1 ”©–Ω—ñ–º–≥–µ –∫–µ—Ç–µ—Ç—ñ–Ω ”©–ª—à–µ–º –±—ñ—Ä–ª—ñ–≥—ñ",
        "qty_buy": "–°–∞—Ç—ã–ø –∞–ª—ã–Ω“ì–∞–Ω –º”©–ª—à–µ—Ä—ñ",
        "price_buy": "–°–∞—Ç—ã–ø –∞–ª—ã–Ω“ì–∞–Ω –±–∞“ì–∞—Å—ã (‚Ç∏)",
        "qty_need": "1 ”©–Ω—ñ–º–≥–µ –∫–µ—Ç–µ—Ç—ñ–Ω –º”©–ª—à–µ—Ä—ñ",
        "add_ing": "‚ûï –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—Ç—ñ “õ–æ—Å—É",
        "added": "—Ç—ñ–∑—ñ–º–≥–µ “õ–æ—Å—ã–ª–¥—ã!",
        "no_ing": "”ò–∑—ñ—Ä—à–µ –µ—à –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –µ–Ω–≥—ñ–∑—ñ–ª–≥–µ–Ω –∂–æ“õ.",
        "unit_list": ["–∫–≥", "–≥", "–ª", "–º–ª", "–¥–∞–Ω–∞", "—Å–º", "–º", "—Ç–æ–Ω–Ω–∞"],
        "save_product": "üíæ ”®–Ω—ñ–º–¥—ñ —Å–∞“õ—Ç–∞—É",
        "product_list": "–°–∞“õ—Ç–∞–ª“ì–∞–Ω ”©–Ω—ñ–º–¥–µ—Ä",
        "period": "–°–∞—Ç—É –ø–µ—Ä–∏–æ–¥—ã",
        "period_list": ["–ö“Ø–Ω—ñ–Ω–µ", "–ê–ø—Ç–∞—Å—ã–Ω–∞", "–ê–π—ã–Ω–∞"],
        "sales_qty": "–°–∞—Ç—É —Å–∞–Ω—ã",
        "fc_title": "3-“õ–∞–¥–∞–º: –¢“±—Ä–∞“õ—Ç—ã —à—ã“ì—ã–Ω–¥–∞—Ä–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑",
        "fc_help": "–¢“±—Ä–∞“õ—Ç—ã —à—ã“ì—ã–Ω–¥–∞—Ä“ì–∞ –∞—Ä–µ–Ω–¥–∞, –∂–∞–ª–∞“õ—ã, –∫–æ–º–º—É–Ω–∞–ª–¥—ã“õ, —Å–∞–ª—ã“õ, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∂–∞—Ç–∞–¥—ã.",
        "fc_add": "‚ûï –¢“±—Ä–∞“õ—Ç—ã —à—ã“ì—ã–Ω “õ–æ—Å—É",
        "fc_name": "–®—ã“ì—ã–Ω –∞—Ç–∞—É—ã",
        "fc_price": "–°–æ–º–∞—Å—ã (‚Ç∏)",
        "calc_title": "4-“õ–∞–¥–∞–º: –ñ–∏—ã–Ω—Ç—ã“õ –∑–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ –Ω“Ø–∫—Ç–µ—Å—ñ",
        "graph_title": "–ñ–∏—ã–Ω—Ç—ã“õ —Ç“Ø—Å—ñ–º –º–µ–Ω —à—ã“ì—ã–Ω –≥—Ä–∞—Ñ–∏–≥—ñ",
        "profit_zone": "–ü–∞–π–¥–∞ –∞–π–º–∞“ì—ã",
        "loss_zone": "–®—ã“ì—ã–Ω –∞–π–º–∞“ì—ã",
        "ai_advice": "–ñ–ò –∫–µ“£–µ—Å—Ç–µ—Ä"
    },
    "–†—É—Å—Å–∫–∏–π": {
        "title": "BusinessGraph Pro ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–π",
        "author": "–ê–≤—Ç–æ—Ä—ã: –ê–±–∏–ª—å–¥–∞–µ–≤–∞ –ê–π—è—Ä—É, –ï—Ä–∞–ª–∏–µ–≤–∞ –ê–π–±–∏–±–∏ (–®–∫–æ–ª–∞ ‚Ññ71, –ê—Ä–∞–ª—å—Å–∫–∏–π —Ä–∞–π–æ–Ω)",
        "desc": "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏, —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è, –æ–±—ä—ë–º–æ–≤ –ø—Ä–æ–¥–∞–∂ –∏ –æ–±—â–µ–π —Ç–æ—á–∫–∏ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏.",
        "product_create": "–®–∞–≥ 1: –†–∞—Å—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞",
        "product_name": "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞",
        "ingredient_title": "–í–≤–µ–¥–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏–µ",
        "ingredient_help": "–ü—Ä–∏–º–µ—Ä: –ú—É–∫–∞, —Å–∞—Ö–∞—Ä, —è–π—Ü–∞, –º–∞—Å–ª–æ. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ –Ω–∞ 1 –∏–∑–¥–µ–ª–∏–µ.",
        "ing_name": "–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞",
        "unit_buy": "–ï–¥–∏–Ω–∏—Ü–∞ –∑–∞–∫—É–ø–∫–∏",
        "unit_need": "–ï–¥–∏–Ω–∏—Ü–∞ —Ä–∞—Å—Ö–æ–¥–∞",
        "qty_buy": "–ó–∞–∫—É–ø–ª–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ",
        "price_buy": "–ó–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞ (‚Ç∏)",
        "qty_need": "–†–∞—Å—Ö–æ–¥ –Ω–∞ 1 –∏–∑–¥–µ–ª–∏–µ",
        "add_ing": "‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç",
        "added": "–¥–æ–±–∞–≤–ª–µ–Ω!",
        "no_ing": "–ü–æ–∫–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.",
        "unit_list": ["–∫–≥", "–≥", "–ª", "–º–ª", "—à—Ç", "—Å–º", "–º", "—Ç–æ–Ω–Ω–∞"],
        "save_product": "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä",
        "product_list": "–°–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤",
        "period": "–ü–µ—Ä–∏–æ–¥ –ø—Ä–æ–¥–∞–∂",
        "period_list": ["–í –¥–µ–Ω—å", "–í –Ω–µ–¥–µ–ª—é", "–í –º–µ—Å—è—Ü"],
        "sales_qty": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂",
        "fc_title": "–®–∞–≥ 3: –í–≤–µ–¥–∏—Ç–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã",
        "fc_help": "–ö —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Ä–∞—Å—Ö–æ–¥–∞–º –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∞—Ä–µ–Ω–¥–∞, –∑–∞—Ä–ø–ª–∞—Ç–∞, –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ, –Ω–∞–ª–æ–≥–∏, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.",
        "fc_add": "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥",
        "fc_name": "–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞",
        "fc_price": "–°—É–º–º–∞ (‚Ç∏)",
        "calc_title": "–®–∞–≥ 4: –û–±—â–∞—è —Ç–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏",
        "graph_title": "–ì—Ä–∞—Ñ–∏–∫ –æ–±—â–µ–π –≤—ã—Ä—É—á–∫–∏ –∏ –∑–∞—Ç—Ä–∞—Ç",
        "profit_zone": "–ó–æ–Ω–∞ –ø—Ä–∏–±—ã–ª–∏",
        "loss_zone": "–ó–æ–Ω–∞ —É–±—ã—Ç–∫–æ–≤",
        "ai_advice": "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ò–ò"
    }
}

TR = TEXT[LANG]

# -------------------------------------------------------
# üîµ ”®–õ–®–ï–ú –ë–Ü–†–õ–Ü–ö–¢–ï–†–Ü –ñ“Æ–ô–ï–°–Ü (–±–∞—Ä–ª—ã“ì—ã–Ω –≥—Ä–∞–º–º/–º–ª/—Å–º-–≥–µ —Ç“Ø—Ä–ª–µ–Ω–¥—ñ—Ä—É)
# -------------------------------------------------------
unit_factor = {
    "–∫–≥": 1000,
    "–≥": 1,
    "–ª": 1000,
    "–º–ª": 1,
    "–¥–∞–Ω–∞": 1,
    "—Å–º": 0.01,
    "–º": 1,
    "—Ç–æ–Ω–Ω–∞": 1000000
}

# -------------------------------------------------------
# üîµ –°–ï–°–°–ò–Ø –ê–ô–ù–´–ú–ê–õ–´–õ–ê–†–´
# -------------------------------------------------------
if "ingredients" not in st.session_state:
    st.session_state.ingredients = []

if "products" not in st.session_state:
    st.session_state.products = []

if "fixed_costs" not in st.session_state:
    st.session_state.fixed_costs = []
# -------------------------------------------------------
# üü¢ 2-–ë”®–õ–Ü–ú: ”®–Ω—ñ–º–Ω—ñ“£ ”©–∑—ñ–Ω–¥—ñ–∫ “õ“±–Ω—ã–Ω –µ—Å–µ–ø—Ç–µ—É –∂”ô–Ω–µ —Å–∞“õ—Ç–∞—É
# -------------------------------------------------------

# –û—Ä—ã—Å—à–∞ "—à—Ç" ”©–ª—à–µ–º—ñ–Ω –¥–µ “õ–æ–ª–¥–∞—É “Ø—à—ñ–Ω:
unit_factor.setdefault("—à—Ç", 1)

# –ë–∞—Å—Ç—ã —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä
st.title(TR["title"])
st.caption(TR["author"])
st.write(TR["desc"])
st.markdown("---")

# ---------------------- ”®–ù–Ü–ú –ë–õ–û–ì–´ ----------------------
st.markdown(f"<div class='block'>", unsafe_allow_html=True)
st.subheader(TR["product_create"])

# ”®–Ω—ñ–º –∞—Ç–∞—É—ã
product_name = st.text_input(TR["product_name"], key="product_name")

st.markdown(f"**{TR['ingredient_title']}**")
st.caption(TR["ingredient_help"])

# –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –µ–Ω–≥—ñ–∑—É —Ñ–æ—Ä–º–∞—Å—ã
col1, col2, col3, col4 = st.columns([2, 1.2, 1.2, 1.2])

with col1:
    ing_name = st.text_input(TR["ing_name"], key="ing_name")

with col2:
    unit_buy = st.selectbox(TR["unit_buy"], TR["unit_list"], key="unit_buy")

with col3:
    qty_buy = st.number_input(TR["qty_buy"], min_value=0.0, step=0.1, key="qty_buy")

with col4:
    price_buy = st.number_input(TR["price_buy"], min_value=0.0, step=50.0, key="price_buy")

col5, col6 = st.columns([1.2, 1.2])

with col5:
    unit_need = st.selectbox(TR["unit_need"], TR["unit_list"], key="unit_need")

with col6:
    qty_need = st.number_input(TR["qty_need"], min_value=0.0, step=1.0, key="qty_need")

# –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—Ç—ñ “õ–æ—Å—É –±–∞—Ç—ã—Ä–º–∞—Å—ã
if st.button(TR["add_ing"]):
    if ing_name and qty_buy > 0 and price_buy > 0 and qty_need > 0:
        # –ë–∞–∑–∞–ª—ã“õ –±—ñ—Ä–ª—ñ–∫–∫–µ —Ç“Ø—Ä–ª–µ–Ω–¥—ñ—Ä—É (–±–∞—Ä–ª—ã“ì—ã–Ω "—à–∞—Ä—Ç—Ç—ã –±—ñ—Ä–ª—ñ–∫–∫–µ" –∫–µ–ª—Ç—ñ—Ä–µ–º—ñ–∑)
        factor_buy = unit_factor.get(unit_buy, 1)
        factor_need = unit_factor.get(unit_need, 1)

        # 1 –±–∞–∑–∞–ª—ã“õ –±—ñ—Ä–ª—ñ–∫ –±–∞“ì–∞—Å—ã
        try:
            unit_price = price_buy / (qty_buy * factor_buy)
        except ZeroDivisionError:
            unit_price = 0

        # 1 ”©–Ω—ñ–º–≥–µ –∫–µ—Ç–µ—Ç—ñ–Ω —à—ã“ì—ã–Ω
        cost_for_product = unit_price * (qty_need * factor_need)

        st.session_state.ingredients.append({
            "–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç": ing_name,
            "–°–∞—Ç—ã–ø –∞–ª—ã–Ω“ì–∞–Ω ”©–ª—à–µ–º—ñ": f"{qty_buy} {unit_buy}",
            "–°–∞—Ç—ã–ø –∞–ª—É –±–∞“ì–∞—Å—ã (‚Ç∏)": price_buy,
            "1 –±—ñ—Ä–ª—ñ–∫ –±–∞“ì–∞—Å—ã (—à–∞—Ä—Ç—Ç—ã)": round(unit_price, 6),
            "1 ”©–Ω—ñ–º–≥–µ “õ–∞–∂–µ—Ç": f"{qty_need} {unit_need}",
            "1 ”©–Ω—ñ–º–≥–µ —à—ã“ì—ã–Ω (‚Ç∏)": round(cost_for_product, 2)
        })

        st.success(f"{ing_name} {TR['added']}")
    else:
        st.warning("–ë–∞—Ä–ª—ã“õ –∂–æ–ª–¥–∞—Ä–¥—ã —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑ / –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.")

# –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—Ç–µ—Ä –∫–µ—Å—Ç–µ—Å—ñ
if st.session_state.ingredients:
    df_ing = pd.DataFrame(st.session_state.ingredients)
    st.write("### –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—Ç–µ—Ä / –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã")
    st.dataframe(df_ing, use_container_width=True)

    total_cost = df_ing["1 ”©–Ω—ñ–º–≥–µ —à—ã“ì—ã–Ω (‚Ç∏)"].sum()
    if LANG == "“ö–∞–∑–∞“õ—à–∞":
        st.info(f"üßÆ 1 ”©–Ω—ñ–º–Ω—ñ“£ –∂–∞–ª–ø—ã ”©–∑—ñ–Ω–¥—ñ–∫ “õ“±–Ω—ã: **{total_cost:.0f} ‚Ç∏**")
    else:
        st.info(f"üßÆ –û–±—â–∞—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å 1 –∏–∑–¥–µ–ª–∏—è: **{total_cost:.0f} ‚Ç∏**")

    # –ù–∞—Ü–µ–Ω–∫–∞
    if LANG == "“ö–∞–∑–∞“õ—à–∞":
        markup = st.number_input("–ù–∞—Ü–µ–Ω–∫–∞ (%)", min_value=0.0, max_value=300.0, value=20.0, step=5.0)
        st.caption("–ù–∞—Ü–µ–Ω–∫–∞ ‚Äì ”©–∑—ñ–Ω–¥—ñ–∫ “õ“±–Ω“ì–∞ “õ–æ—Å—ã–ª–∞—Ç—ã–Ω “Ø—Å—Ç–µ–º–µ. –ú—ã—Å–∞–ª—ã, 20% –Ω–µ–º–µ—Å–µ 30%.")
    else:
        markup = st.number_input("–ù–∞—Ü–µ–Ω–∫–∞ (%)", min_value=0.0, max_value=300.0, value=20.0, step=5.0)
        st.caption("–ù–∞—Ü–µ–Ω–∫–∞ ‚Äì —ç—Ç–æ –ø—Ä–æ—Ü–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –¥–æ–±–∞–≤–ª—è–µ—Ç–µ –∫ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 20% –∏–ª–∏ 30%).")

    final_price = total_cost * (1 + markup / 100)

    if LANG == "“ö–∞–∑–∞“õ—à–∞":
        st.success(f"üü¶ “∞—Å—ã–Ω—ã–ª“ì–∞–Ω —Å–∞—Ç—É –±–∞“ì–∞—Å—ã: **{final_price:.0f} ‚Ç∏**")
    else:
        st.success(f"üü¶ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏: **{final_price:.0f} ‚Ç∏**")

    # ”®–Ω—ñ–º–¥—ñ —Å–∞“õ—Ç–∞—É
    if st.button(TR["save_product"]):
        if not product_name:
            if LANG == "“ö–∞–∑–∞“õ—à–∞":
                st.error("”®–Ω—ñ–º –∞—Ç–∞—É—ã–Ω –∂–∞–∑—ã“£—ã–∑.")
            else:
                st.error("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞.")
        else:
            st.session_state.products.append({
                "name": product_name,
                "cost": float(total_cost),
                "price": float(final_price),
                "qty": 0  # —Å–∞—Ç—ã–ª—ã–º —Å–∞–Ω—ã –∫–µ–π—ñ–Ω –µ–Ω–≥—ñ–∑—ñ–ª–µ–¥—ñ
            })
            # –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—Ç–µ—Ä–¥—ñ —Ç–∞–∑–∞—Ä—Ç—É ‚Äì –∫–µ–ª–µ—Å—ñ ”©–Ω—ñ–º “Ø—à—ñ–Ω
            st.session_state.ingredients = []
            if LANG == "“ö–∞–∑–∞“õ—à–∞":
                st.success("”®–Ω—ñ–º —Å–∞“õ—Ç–∞–ª–¥—ã!")
            else:
                st.success("–¢–æ–≤–∞—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω!")
else:
    st.info(TR["no_ing"])

st.markdown("</div>", unsafe_allow_html=True)

# ---------------------- ”®–ù–Ü–ú–î–ï–† –¢–Ü–ó–Ü–ú–Ü ----------------------
st.markdown(f"<div class='block'>", unsafe_allow_html=True)
st.subheader(TR["product_list"])

if st.session_state.products:
    # –ü–µ—Ä–∏–æ–¥—Ç—ã —Ç–∞“£–¥–∞—É
    period = st.selectbox(TR["period"], TR["period_list"], key="period")
    if LANG == "“ö–∞–∑–∞“õ—à–∞":
        st.caption("–ë“±–ª –ø–µ—Ä–∏–æ–¥“õ–∞ —Å”ô–π–∫–µ—Å —Å–∞—Ç—ã–ª—ã–º —Å–∞–Ω—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑ (–º—ã—Å–∞–ª—ã, –∫“Ø–Ω—ñ–Ω–µ –Ω–µ—à–µ –¥–∞–Ω–∞ —Å–∞—Ç—ã–ª–∞–¥—ã).")
    else:
        st.caption("–í–≤–µ–¥–∏—Ç–µ –æ–±—ä—ë–º –ø—Ä–æ–¥–∞–∂ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∫–æ–ª—å–∫–æ —à—Ç—É–∫ –ø—Ä–æ–¥–∞—ë—Ç—Å—è –≤ –¥–µ–Ω—å/–Ω–µ–¥–µ–ª—é/–º–µ—Å—è—Ü).")

    # ”ò—Ä ”©–Ω—ñ–º–≥–µ —Å–∞—Ç—ã–ª—ã–º —Å–∞–Ω—ã–Ω –µ–Ω–≥—ñ–∑—É
    updated_products = []
    for i, prod in enumerate(st.session_state.products):
        col_p1, col_p2, col_p3, col_p4 = st.columns([3, 2, 2, 2])
        with col_p1:
            st.markdown(f"**{prod['name']}**")
        with col_p2:
            st.markdown(f"”®–∑—ñ–Ω–¥—ñ–∫ “õ“±–Ω / –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å: **{prod['cost']:.0f} ‚Ç∏**")
        with col_p3:
            st.markdown(f"–ë–∞“ì–∞ / –¶–µ–Ω–∞: **{prod['price']:.0f} ‚Ç∏**")
        with col_p4:
            qty_key = f"qty_{i}"
            qty_val = st.number_input(
                f"{TR['sales_qty']} ({prod['name']})",
                min_value=0,
                step=1,
                key=qty_key
            )
            prod["qty"] = int(qty_val)
        updated_products.append(prod)

    st.session_state.products = updated_products

    # –ö–µ—Å—Ç–µ —Ç“Ø—Ä—ñ–Ω–¥–µ –∫”©—Ä—Å–µ—Ç—É
    df_products = pd.DataFrame([
        {
            "”®–Ω—ñ–º / –¢–æ–≤–∞—Ä": p["name"],
            "”®–∑—ñ–Ω–¥—ñ–∫ “õ“±–Ω": p["cost"],
            "–ë–∞“ì–∞": p["price"],
            "–°–∞—Ç—É —Å–∞–Ω—ã": p["qty"]
        }
        for p in st.session_state.products
    ])
    st.dataframe(df_products, use_container_width=True)
else:
    if LANG == "“ö–∞–∑–∞“õ—à–∞":
        st.info("”ò–∑—ñ—Ä—à–µ —Å–∞“õ—Ç–∞–ª“ì–∞–Ω ”©–Ω—ñ–º –∂–æ“õ.")
    else:
        st.info("–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤.")

st.markdown("</div>", unsafe_allow_html=True)
# -------------------------------------------------------
# üî¥ 3-–ë”®–õ–Ü–ú: –¢“±—Ä–∞“õ—Ç—ã —à—ã“ì—ã–Ω–¥–∞—Ä, –∂–∏—ã–Ω—Ç—ã“õ –µ—Å–µ–ø, –≥—Ä–∞—Ñ–∏–∫, –ñ–ò –∫–µ“£–µ—Å
# -------------------------------------------------------

st.markdown(f"<div class='block'>", unsafe_allow_html=True)
st.subheader(TR["fc_title"])
st.caption(TR["fc_help"])

# –¢“±—Ä–∞“õ—Ç—ã —à—ã“ì—ã–Ω –µ–Ω–≥—ñ–∑—É —Ñ–æ—Ä–º–∞—Å—ã
col_fc1, col_fc2 = st.columns([3, 2])
with col_fc1:
    fc_name = st.text_input(TR["fc_name"], key="fc_name")
with col_fc2:
    fc_price = st.number_input(TR["fc_price"], min_value=0.0, step=1000.0, key="fc_price")

if st.button(TR["fc_add"]):
    if fc_name and fc_price > 0:
        st.session_state.fixed_costs.append({
            "–ê—Ç–∞—É—ã": fc_name,
            "–°–æ–º–∞—Å—ã": float(fc_price)
        })
        if LANG == "“ö–∞–∑–∞“õ—à–∞":
            st.success("–¢“±—Ä–∞“õ—Ç—ã —à—ã“ì—ã–Ω “õ–æ—Å—ã–ª–¥—ã.")
        else:
            st.success("–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω.")
    else:
        if LANG == "“ö–∞–∑–∞“õ—à–∞":
            st.warning("–®—ã“ì—ã–Ω –∞—Ç–∞—É—ã –º–µ–Ω —Å–æ–º–∞—Å—ã–Ω —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑.")
        else:
            st.warning("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–∞.")

# –¢“±—Ä–∞“õ—Ç—ã —à—ã“ì—ã–Ω–¥–∞—Ä –∫–µ—Å—Ç–µ—Å—ñ
if st.session_state.fixed_costs:
    df_fc = pd.DataFrame(st.session_state.fixed_costs)
    st.write("### –¢“±—Ä–∞“õ—Ç—ã —à—ã“ì—ã–Ω–¥–∞—Ä / –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã")
    st.table(df_fc)
    total_fc = df_fc["–°–æ–º–∞—Å—ã"].sum()
else:
    total_fc = 0.0
    if LANG == "“ö–∞–∑–∞“õ—à–∞":
        st.info("–¢“±—Ä–∞“õ—Ç—ã —à—ã“ì—ã–Ω–¥–∞—Ä –µ–Ω–≥—ñ–∑—ñ–ª–º–µ–≥–µ–Ω.")
    else:
        st.info("–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ–∫–∞ –Ω–µ –≤–≤–µ–¥–µ–Ω—ã.")

if LANG == "“ö–∞–∑–∞“õ—à–∞":
    st.info(f"–ñ–∞–ª–ø—ã —Ç“±—Ä–∞“õ—Ç—ã —à—ã“ì—ã–Ω (FC): **{total_fc:.0f} ‚Ç∏**")
else:
    st.info(f"–û–±—â–∏–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (FC): **{total_fc:.0f} ‚Ç∏**")

st.markdown("</div>", unsafe_allow_html=True)

# -------------------------------------------------------
# üî¥ 4-“õ–∞–¥–∞–º: –ñ–∏—ã–Ω—Ç—ã“õ –∑–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ –Ω“Ø–∫—Ç–µ—Å—ñ –∂”ô–Ω–µ –≥—Ä–∞—Ñ–∏–∫
# -------------------------------------------------------
st.markdown(f"<div class='block'>", unsafe_allow_html=True)
st.subheader(TR["calc_title"])

# ”®–Ω—ñ–º–¥–µ—Ä –º–µ–Ω —Å–∞—Ç—ã–ª—ã–º —Å–∞–Ω—ã–Ω —Ç–µ–∫—Å–µ—Ä—É
valid_products = [p for p in st.session_state.products if p["qty"] > 0]

if not valid_products:
    if LANG == "“ö–∞–∑–∞“õ—à–∞":
        st.info("–ó–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ –Ω“Ø–∫—Ç–µ—Å—ñ–Ω –µ—Å–µ–ø—Ç–µ—É “Ø—à—ñ–Ω –∫–µ–º—ñ–Ω–¥–µ –±—ñ—Ä ”©–Ω—ñ–º–≥–µ —Å–∞—Ç—É —Å–∞–Ω—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑.")
    else:
        st.info("–î–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ç–æ—á–∫–∏ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ –≤–≤–µ–¥–∏—Ç–µ –æ–±—ä—ë–º—ã –ø—Ä–æ–¥–∞–∂ —Ö–æ—Ç—è –±—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞.")
elif total_fc <= 0:
    if LANG == "“ö–∞–∑–∞“õ—à–∞":
        st.info("–ê–ª–¥—ã–º–µ–Ω —Ç“±—Ä–∞“õ—Ç—ã —à—ã“ì—ã–Ω–¥–∞—Ä–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑.")
    else:
        st.info("–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã.")
else:
    # –ü–µ—Ä–∏–æ–¥
    period = st.session_state.get("period", TR["period_list"][0])

    # –ü–µ—Ä–∏–æ–¥ –∞—Ç–∞—É—ã–Ω —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä—É
    if LANG == "“ö–∞–∑–∞“õ—à–∞":
        st.write(f"–ï—Å–µ–ø—Ç–µ—É –ø–µ—Ä–∏–æ–¥—ã: **{period}**")
    else:
        st.write(f"–ü–µ—Ä–∏–æ–¥ —Ä–∞—Å—á—ë—Ç–∞: **{period}**")

    # –ñ–∏—ã–Ω—Ç—ã“õ —Ç“Ø—Å—ñ–º –º–µ–Ω –∞–π–Ω—ã–º–∞–ª—ã —à—ã“ì—ã–Ω (–±—ñ—Ä –ø–µ—Ä–∏–æ–¥“õ–∞)
    total_revenue_per_period = sum(p["price"] * p["qty"] for p in valid_products)
    total_varcost_per_period = sum(p["cost"] * p["qty"] for p in valid_products)
    contribution_per_period = total_revenue_per_period - total_varcost_per_period

    col_sum1, col_sum2, col_sum3 = st.columns(3)
    with col_sum1:
        if LANG == "“ö–∞–∑–∞“õ—à–∞":
            st.metric("–ü–µ—Ä–∏–æ–¥—Ç–∞“ì—ã –∂–∞–ª–ø—ã —Ç“Ø—Å—ñ–º", f"{total_revenue_per_period:.0f} ‚Ç∏")
        else:
            st.metric("–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥", f"{total_revenue_per_period:.0f} ‚Ç∏")
    with col_sum2:
        if LANG == "“ö–∞–∑–∞“õ—à–∞":
            st.metric("–ü–µ—Ä–∏–æ–¥—Ç–∞“ì—ã –∞–π–Ω—ã–º–∞–ª—ã —à—ã“ì—ã–Ω", f"{total_varcost_per_period:.0f} ‚Ç∏")
        else:
            st.metric("–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã –∑–∞ –ø–µ—Ä–∏–æ–¥", f"{total_varcost_per_period:.0f} ‚Ç∏")
    with col_sum3:
        if LANG == "“ö–∞–∑–∞“õ—à–∞":
            st.metric("–ü–µ—Ä–∏–æ–¥—Ç–∞“ì—ã –º–∞—Ä–∂–∞ (—Ç“Ø—Å—ñ–º - –∞–π–Ω—ã–º–∞–ª—ã —à—ã“ì—ã–Ω)", f"{contribution_per_period:.0f} ‚Ç∏")
        else:
            st.metric("–ú–∞—Ä–∂–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥ (–≤—ã—Ä—É—á–∫–∞ - –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)", f"{contribution_per_period:.0f} ‚Ç∏")

    if contribution_per_period <= 0:
        # –ü–∞–π–¥–∞ –∂–æ“õ –Ω–µ–º–µ—Å–µ —Ç–µ—Ä—ñ—Å –±–æ–ª—Å–∞, –∑–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ –Ω“Ø–∫—Ç–µ—Å—ñ –±–æ–ª–º–∞–π–¥—ã
        if LANG == "“ö–∞–∑–∞“õ—à–∞":
            st.error("“ö–∞–∑—ñ—Ä–≥—ñ –±–∞“ì–∞ –º–µ–Ω —Å–∞—Ç—É –∫”©–ª–µ–º—ñ–Ω–¥–µ –º–∞—Ä–∂–∞ —Ç–µ—Ä—ñ—Å –Ω–µ–º–µ—Å–µ –Ω”©–ª–≥–µ –∂–∞“õ—ã–Ω. –ó–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ –Ω“Ø–∫—Ç–µ—Å—ñ –µ—Å–µ–ø—Ç–µ–ª–º–µ–π–¥—ñ. –ë–∞“ì–∞–Ω—ã –∫”©—Ç–µ—Ä—É –Ω–µ–º–µ—Å–µ —à—ã“ì—ã–Ω–¥—ã –∞–∑–∞–π—Ç—É “õ–∞–∂–µ—Ç.")
        else:
            st.error("–ü—Ä–∏ —Ç–µ–∫—É—â–∏—Ö —Ü–µ–Ω–∞—Ö –∏ –æ–±—ä–µ–º–∞—Ö –ø—Ä–æ–¥–∞–∂ –º–∞—Ä–∂–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è –∏–ª–∏ –æ–∫–æ–ª–æ –Ω—É–ª—è. –¢–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–≤—ã—Å–∏—Ç—å —Ü–µ–Ω—ã –∏–ª–∏ —Å–Ω–∏–∑–∏—Ç—å –∑–∞—Ç—Ä–∞—Ç—ã.")
    else:
        # –ó–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ“õ–∞ –∂–µ—Ç—É “Ø—à—ñ–Ω –Ω–µ—à–µ –ø–µ—Ä–∏–æ–¥ –∫–µ—Ä–µ–∫
        periods_to_break_even = total_fc / contribution_per_period

        # –ü–µ—Ä–∏–æ–¥—Ç–∞“ì—ã –∂–∞–ª–ø—ã ”©–Ω—ñ–º —Å–∞–Ω—ã
        total_units_per_period = sum(p["qty"] for p in valid_products)
        if total_units_per_period > 0:
            units_to_break_even = periods_to_break_even * total_units_per_period
        else:
            units_to_break_even = 0

        # –ì—Ä–∞—Ñ–∏–∫ “Ø—à—ñ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω (–ø–µ—Ä–∏–æ–¥ —Å–∞–Ω—ã)
        max_periods = max(int(periods_to_break_even * 2), int(periods_to_break_even) + 2, 5)
        x_periods = list(range(0, max_periods + 1))
        revenue_curve = [total_revenue_per_period * t for t in x_periods]
        total_cost_curve = [total_fc + total_varcost_per_period * t for t in x_periods]

        fig = go.Figure()
        fig.add_trace(go.Scatter(
            x=x_periods,
            y=revenue_curve,
            mode="lines+markers",
            name="–¢“Ø—Å—ñ–º / –í—ã—Ä—É—á–∫–∞"
        ))
        fig.add_trace(go.Scatter(
            x=x_periods,
            y=total_cost_curve,
            mode="lines+markers",
            name="–ñ–∞–ª–ø—ã —à—ã“ì—ã–Ω / –û–±—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã"
        ))

        # –í–∏—Ä—Ç—É–∞–ª–¥—ã –∑–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ –≤–µ—Ä—Ç–∏–∫–∞–ª—å —Å—ã–∑—ã“ì—ã
        fig.add_vline(
            x=periods_to_break_even,
            line_width=2,
            line_dash="dash",
            line_color="red"
        )

        # –û—Å—å –∞—Ç–∞—É–ª–∞—Ä—ã
        if LANG == "“ö–∞–∑–∞“õ—à–∞":
            x_title = "–ü–µ—Ä–∏–æ–¥ —Å–∞–Ω—ã (–∫“Ø–Ω/–∞–ø—Ç–∞/–∞–π)"
            y_title = "–°–æ–º–∞ (‚Ç∏)"
            graph_title = TR["graph_title"]
        else:
            x_title = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–∏–æ–¥–æ–≤ (–¥–Ω–µ–π/–Ω–µ–¥–µ–ª—å/–º–µ—Å—è—Ü–µ–≤)"
            y_title = "–°—É–º–º–∞ (‚Ç∏)"
            graph_title = TR["graph_title"]

        fig.update_layout(
            title=graph_title,
            xaxis_title=x_title,
            yaxis_title=y_title,
            legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1)
        )

        st.plotly_chart(fig, use_container_width=True)

        # –ù”ô—Ç–∏–∂–µ–Ω—ñ —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä—É
        if LANG == "“ö–∞–∑–∞“õ—à–∞":
            st.success(
                f"–ó–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ –Ω“Ø–∫—Ç–µ—Å—ñ–Ω–µ —à–∞–º–∞–º–µ–Ω **{periods_to_break_even:.1f} –ø–µ—Ä–∏–æ–¥—Ç–∞–Ω** –∫–µ–π—ñ–Ω –∂–µ—Ç–µ—Å—ñ–∑ "
                f"(–±–∞—Ä–ª—ã“õ ”©–Ω—ñ–º “õ“±—Ä—ã–ª—ã–º—ã–Ω –∂”ô–Ω–µ –±–∞“ì–∞—Å—ã–Ω ”©–∑–≥–µ—Ä—ñ—Å—Å—ñ–∑ —Å–∞“õ—Ç–∞“ì–∞–Ω–¥–∞)."
            )
            if total_units_per_period > 0:
                st.info(
                    f"–ë“±–ª —à–∞–º–∞–º–µ–Ω **{units_to_break_even:.0f} ”©–Ω—ñ–º** –¥–µ–≥–µ–Ω —Å”©–∑ "
                    f"({period} —Å–∞—Ç—ã–ª—ã–º “õ“±—Ä—ã–ª—ã–º—ã–Ω–∞ —Å”ô–π–∫–µ—Å)."
                )
        else:
            st.success(
                f"–í—ã –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç–µ —Ç–æ—á–∫–∏ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ —á–µ—Ä–µ–∑ **{periods_to_break_even:.1f} –ø–µ—Ä–∏–æ–¥–æ–≤**, "
                f"–µ—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–¥–∞–∂ –∏ —Ü–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è."
            )
            if total_units_per_period > 0:
                st.info(
                    f"–≠—Ç–æ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ –ø—Ä–∏–º–µ—Ä–Ω–æ **{units_to_break_even:.0f} –µ–¥–∏–Ω–∏—Ü–∞–º –ø—Ä–æ–¥—É–∫—Ü–∏–∏** "
                    f"–ø—Ä–∏ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–æ–¥–∞–∂ –∑–∞ {period.lower()}."
                )

        # ---------------------------------------------------
        # –ñ–ò –°–¢–ò–õ–Ü–ù–î–ï –ü–ê–ô–î–ê–õ–´ –ö–ï“¢–ï–°–¢–ï–† / –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ò–ò
        # ---------------------------------------------------
        st.markdown("---")
        st.subheader(TR["ai_advice"])

        # –ï“£ –º–∞—Ä–∂–∞–ª—ã ”©–Ω—ñ–º–¥—ñ —Ç–∞–±—É
        enriched = []
        for p in valid_products:
            margin_per_unit = p["price"] - p["cost"]
            enriched.append((p["name"], p["cost"], p["price"], p["qty"], margin_per_unit))
        enriched_sorted = sorted(enriched, key=lambda x: x[4], reverse=True)

        if LANG == "“ö–∞–∑–∞“õ—à–∞":
            st.write("–ê“ì—ã–º–¥–∞“ì—ã –¥–µ—Ä–µ–∫—Ç–µ—Ä –Ω–µ–≥—ñ–∑—ñ–Ω–¥–µ –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ “õ“±—Ä—ã–ª“ì–∞–Ω —Ç–∞–ª–¥–∞—É:")

            # 1) –ú–∞—Ä–∂–∞ –±–æ–π—ã–Ω—à–∞
            if enriched_sorted:
                top_product = enriched_sorted[0]
                st.markdown(
                    f"‚Ä¢ –ï“£ –º–∞—Ä–∂–∞–ª—ã ”©–Ω—ñ–º: **{top_product[0]}**. –ë—ñ—Ä –¥–∞–Ω–∞–¥–∞–Ω —Ç“Ø—Å–µ—Ç—ñ–Ω –ø–∞–π–¥–∞ —à–∞–º–∞–º–µ–Ω "
                    f"**{top_product[4]:.0f} ‚Ç∏**. –û—Å—ã ”©–Ω—ñ–º–≥–µ –∂–∞—Ä–Ω–∞–º–∞ –º–µ–Ω —Å–∞—Ç—ã–ª—ã–º–¥—ã –∫“Ø—à–µ–π—Ç—É —Ç–∏—ñ–º–¥—ñ."
                )

            # 2) –ë–∞“ì–∞–Ω—ã 10% ”©—Å—ñ—Ä—É ”ô—Å–µ—Ä—ñ
            price_up_factor = 1.10
            new_contribution = sum((p["price"] * price_up_factor - p["cost"]) * p["qty"] for p in valid_products)
            if new_contribution > 0:
                new_periods_to_be = total_fc / new_contribution
                st.markdown(
                    f"‚Ä¢ –ï–≥–µ—Ä –±–∞—Ä–ª—ã“õ ”©–Ω—ñ–º –±–∞“ì–∞—Å—ã–Ω **10%**-“ì–∞ ”©—Å—ñ—Ä—Å–µ“£—ñ–∑, –∑–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ –Ω“Ø–∫—Ç–µ—Å—ñ "
                    f"**{periods_to_break_even:.1f} –ø–µ—Ä–∏–æ–¥—Ç–∞–Ω** —à–∞–º–∞–º–µ–Ω **{new_periods_to_be:.1f} –ø–µ—Ä–∏–æ–¥“õ–∞** –¥–µ–π—ñ–Ω —Ç”©–º–µ–Ω–¥–µ–π–¥—ñ."
                )

            # 3) –¢–∏—ñ–º—Å—ñ–∑ –∂–∞“õ“õ–∞ –µ—Å–∫–µ—Ä—Ç—É
            low_margin = [p for p in enriched_sorted if p[4] <= 0]
            if low_margin:
                names = ", ".join(p[0] for p in low_margin)
                st.markdown(
                    f"‚Ä¢ –ö–µ–ª–µ—Å—ñ ”©–Ω—ñ–º–¥–µ—Ä –±–æ–π—ã–Ω—à–∞ –ø–∞–π–¥–∞ ”©—Ç–µ —Ç”©–º–µ–Ω –Ω–µ–º–µ—Å–µ –∂–æ“õ: **{names}**. "
                    f"–ë“±–ª ”©–Ω—ñ–º–¥–µ—Ä–¥—ñ“£ –±–∞“ì–∞—Å—ã–Ω “õ–∞–π—Ç–∞ “õ–∞—Ä–∞–ø –Ω–µ–º–µ—Å–µ —à—ã“ì—ã–Ω—ã–Ω –∞–∑–∞–π—Ç“õ–∞–Ω –¥“±—Ä—ã—Å."
                )

            # 4) –ñ–∞–ª–ø—ã “±—Å—ã–Ω—ã—Å
            st.markdown(
                "‚Ä¢ –ï–≥–µ—Ä –∑–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ –Ω“Ø–∫—Ç–µ—Å—ñ–Ω–µ —Ç–µ–∑—ñ—Ä–µ–∫ –∂–µ—Ç–∫—ñ“£—ñ–∑ –∫–µ–ª—Å–µ, –µ–∫—ñ –±–∞“ì—ã—Ç—Ç–∞ –∂“±–º—ã—Å —ñ—Å—Ç–µ“£—ñ–∑: "
                "**–±–∞“ì–∞–Ω—ã –æ“£—Ç–∞–π–ª—ã –∫”©—Ç–µ—Ä—É** –∂”ô–Ω–µ **”©–∑—ñ–Ω–¥—ñ–∫ “õ“±–Ω–¥—ã —Ç”©–º–µ–Ω–¥–µ—Ç—É** (—à–∏–∫—ñ–∑–∞—Ç –±–∞“ì–∞—Å—ã–Ω, –ª–æ–≥–∏—Å—Ç–∏–∫–∞–Ω—ã, –∞—Ä—Ç—ã“õ —à—ã“ì—ã–Ω–¥–∞—Ä–¥—ã –∞–∑–∞–π—Ç—É)."
            )

        else:
            st.write("–ê–Ω–∞–ª–∏–∑, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö:")

            # 1) –ü–æ –º–∞—Ä–∂–µ
            if enriched_sorted:
                top_product = enriched_sorted[0]
                st.markdown(
                    f"‚Ä¢ –°–∞–º—ã–π –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω—ã–π —Ç–æ–≤–∞—Ä: **{top_product[0]}**. –ü—Ä–∏–±—ã–ª—å —Å –æ–¥–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã –æ–∫–æ–ª–æ "
                    f"**{top_product[4]:.0f} ‚Ç∏**. –¶–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–æ —É—Å–∏–ª–∏—Ç—å –ø—Ä–æ–¥–∞–∂–∏ –∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞."
                )

            # 2) –≠—Ñ—Ñ–µ–∫—Ç +10% –∫ —Ü–µ–Ω–µ
            price_up_factor = 1.10
            new_contribution = sum((p["price"] * price_up_factor - p["cost"]) * p["qty"] for p in valid_products)
            if new_contribution > 0:
                new_periods_to_be = total_fc / new_contribution
                st.markdown(
                    f"‚Ä¢ –ï—Å–ª–∏ –ø–æ–≤—ã—Å–∏—Ç—å —Ü–µ–Ω—ã –Ω–∞ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –Ω–∞ **10%**, —Ç–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ —Å–Ω–∏–∑–∏—Ç—Å—è "
                    f"—Å **{periods_to_break_even:.1f} –ø–µ—Ä–∏–æ–¥–æ–≤** –¥–æ –ø—Ä–∏–º–µ—Ä–Ω–æ **{new_periods_to_be:.1f} –ø–µ—Ä–∏–æ–¥–æ–≤**."
                )

            # 3) –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–∏–∑–∫–æ–π –º–∞—Ä–∂–µ
            low_margin = [p for p in enriched_sorted if p[4] <= 0]
            if low_margin:
                names = ", ".join(p[0] for p in low_margin)
                st.markdown(
                    f"‚Ä¢ –ü–æ —Å–ª–µ–¥—É—é—â–∏–º —Ç–æ–≤–∞—Ä–∞–º –ø—Ä–∏–±—ã–ª—å –æ—á–µ–Ω—å –Ω–∏–∑–∫–∞—è –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: **{names}**. "
                    f"–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Ü–µ–Ω—ã –∏–ª–∏ —Å–Ω–∏–∑–∏—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å."
                )

            # 4) –û–±—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
            st.markdown(
                "‚Ä¢ –ß—Ç–æ–±—ã –±—ã—Å—Ç—Ä–µ–µ –≤—ã–π—Ç–∏ –≤ –∑–æ–Ω—É –ø—Ä–∏–±—ã–ª–∏, —Ä–∞–±–æ—Ç–∞–π—Ç–µ –≤ –¥–≤—É—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö: "
                "**–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ü–µ–Ω** –∏ **—Å–Ω–∏–∂–µ–Ω–∏–µ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏** (—Å—Ç–æ–∏–º–æ—Å—Ç—å —Å—ã—Ä—å—è, –ª–æ–≥–∏—Å—Ç–∏–∫–∞, —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤)."
            )

st.markdown("</div>", unsafe_allow_html=True)
